/*! HTML5 Finder - v1.0.dev1 - 2013-09-27
* https://github.com/jgerigmeyer/jquery-html5finder
* Copyright (c) 2013 Jonny Gerig Meyer; Licensed MIT */
!function(a){"use strict";var b={},c={init:function(b){var d=a.extend({},a.fn.html5finder.defaults,b),e=a(this),f=e.find(d.finderSelector),g=f.find(d.sectionSelector).length||1;c.updateNumberCols(f,g),c.markSelected(f,b),c.attachHandler(e,f,b)},markSelected:function(b,c){var d=a.extend({},a.fn.html5finder.defaults,c);b.find(d.selected).data("selected",!0),b.find(d.notSelected).data("selected",!1)},updateNumberCols:function(a,b){a.data("cols",b).attr("data-cols",b)},horzScroll:function(b,c,d,e){var f=a.extend({},a.fn.html5finder.defaults,d),g=a.Deferred();if(f.horizontalScroll){var h=0,i=c.scrollLeft(),j=b.find(f.sectionSelector+".focus"),k=j.prev(f.sectionSelector);k.length&&(h=i+k.position().left,e&&(h-=c.innerWidth()-j.outerWidth()-k.outerWidth())),i===h?g.resolve():a.when(c.animate({scrollLeft:h},"fast")).done(function(){g.resolve()})}else g.resolve();return g},addItems:function(b,d,e,f,g,h){var i,j=a.extend({},a.fn.html5finder.defaults,h),k=f.find(j.scrollContainer);b.colname=d,i=j.itemTplFn(b),e.find(j.sectionContentSelector).html(i),c.horzScroll(g,k,h),j.itemsAddedCallback&&j.itemsAddedCallback(i)},attachHandler:function(b,d,e){var f=a.extend({},a.fn.html5finder.defaults,e),g=b.find(f.scrollContainer);d.on("click",f.itemSelector,function(){c.itemClick(b,d,a(this),e)}),d.on("click",f.labelSelector,function(b){var h=a(this),i=h.closest(f.sectionSelector);i.find("#"+h.attr("for")).is(":disabled")&&(i.addClass("focus").siblings(f.sectionSelector).removeClass("focus"),c.horzScroll(d,g,e)),b.stopPropagation()}),d.on("click",f.sectionSelector,function(b){var h=a(this);a(b.target).is("input, label")||(h.addClass("focus").siblings(f.sectionSelector).removeClass("focus"),c.horzScroll(d,g,e))})},itemClick:function(d,e,f,g){var h,i,j,k=a.extend({},a.fn.html5finder.defaults,g),l=d.find(k.scrollContainer),m=f.closest(k.sectionSelector),n=f.data("url"),o=m.next(k.sectionSelector);if(f.data("selected")===!0)m.hasClass("focus")?o.addClass("focus").siblings(k.sectionSelector).removeClass("focus"):m.addClass("focus").siblings(k.sectionSelector).removeClass("focus"),o.nextAll(k.sectionSelector).empty(),o.find("input:checked").removeAttr("checked").data("selected",!1),a.when(c.horzScroll(e,l,g)).done(function(){o.nextAll(k.sectionSelector).remove(),j=e.find(k.sectionSelector).length,c.updateNumberCols(e,j)}),f.data("children")&&k.itemSelectedCallback&&k.itemSelectedCallback(f);else{if(f.data("children")){var p=function(){if(j=m.prevAll(k.sectionSelector).addBack().removeClass("focus").length+1,c.updateNumberCols(e,j),h="col"+j.toString(),i=k.columnTplFn({colname:h}),o.length?(o.nextAll(k.sectionSelector).remove(),o.replaceWith(i)):m.after(i),k.cache&&b[f.attr("id")]){var l=b[f.attr("id")];c.addItems(l,h,i,d,e,g)}else k.loading&&i.loadingOverlay(),a.when(a.get(n)).done(function(a){b[f.attr("id")]=a,c.addItems(a,h,i,d,e,g)}).always(function(){k.loading&&i.loadingOverlay("remove")})};o.length&&!o.hasClass("focus")?(o.nextAll(k.sectionSelector).addBack().empty(),o.addClass("focus").siblings(k.sectionSelector).removeClass("focus"),a.when(c.horzScroll(e,l,g,!0)).done(function(){p()})):p(),k.itemSelectedCallback&&k.itemSelectedCallback(f)}else m.addClass("focus").siblings(k.sectionSelector).removeClass("focus"),a.when(c.horzScroll(e,l,g,!0)).done(function(){m.nextAll(k.sectionSelector).remove(),j=e.find(k.sectionSelector).length,c.updateNumberCols(e,j)}),k.lastChildSelectedCallback&&k.lastChildSelectedCallback(f);c.markSelected(e,g)}},exposeMethods:function(){return c}};a.fn.html5finder=function(b){return c[b]?c[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?(a.error("Method "+b+" does not exist on jQuery.html5finder"),void 0):c.init.apply(this,arguments)},a.fn.html5finder.defaults={itemTplFn:null,columnTplFn:null,loading:!1,horizontalScroll:!1,scrollContainer:null,scrollSpeed:500,selected:"input:checked",notSelected:"input:not(:checked)",finderSelector:".finder-body",headerSelector:"header",sectionSelector:null,sectionContentSelector:null,itemSelector:".finderinput",labelSelector:".finderselect",itemSelectedCallback:null,lastChildSelectedCallback:null,itemsAddedCallback:null,sortLinkSelector:".sortlink",cache:!0}}(jQuery);